import{useState as m,useEffect as Z,useCallback as Te}from"@dropins/tools/preact-compat.js";import{events as ae}from"@dropins/tools/event-bus.js";import{Divider as Ne,PriceSummary as De,Price as c,Picker as ye,Input as xe,Button as ve,CartList as Ee,CartItem as Le,Image as Ie}from"@dropins/tools/components.js";import{E as Pe}from"../chunks/MiniCart.js";import{classes as R,VComponent as ie}from"@dropins/tools/lib.js";import{jsx as r,jsxs as re,Fragment as ne}from"@dropins/tools/preact-jsx-runtime.js";import{l as Se,s as be,k as Ce}from"../chunks/resetCart.js";import{b as fe,u as we}from"../chunks/updateProductsFromCart.js";import{c as Ue,a as Ge,b as ke,g as Xe}from"../chunks/getEstimatedTotals.js";import{useText as Fe}from"@dropins/tools/i18n.js";import"@dropins/tools/fetch-graphql.js";const Ae=({className:F,children:y,emptyCart:b,heading:_,products:v,priceSummary:h,...t})=>r("div",{...t,className:R(["cart-cart",F]),children:re("div",{className:R(["cart-cart__wrapper"]),children:[_&&re("div",{className:R(["cart-cart__heading",["cart-cart__heading--full-width",!v||!h]]),children:[r(ie,{node:_,className:"cart-cart__heading-text"}),r(Ne,{variant:"primary",className:R(["cart-cart__heading-divider"])})]}),r("div",{className:R(["cart-cart__content",["cart-cart__content--empty",!v],["cart-cart__content--full-width",!h]]),children:v||r(ie,{node:b,className:"cart-cart__empty-cart"})}),v&&h&&r(ie,{node:h,className:R(["cart-cart__price-summary"])})]})}),ze=()=>{const[F,y]=m(!1),[b,_]=m();return{handleEstimateTotals:(h,t)=>{y(!0);const{shippingCountry:D,shippingState:O="",shippingZip:E=""}=h,$={countryCode:D,postcode:E,region:{region:O},shipping_method:{carrier_code:(t==null?void 0:t.carrier_code)||"",method_code:(t==null?void 0:t.method_code)||""}};Ue($).then(l=>{var U,S,G,d,A,L,k,I,N,P,z,C,a,x,u,p,o,i,n,Y;l&&_({estimatedTaxTotal:{amount:(U=l.totalTax)==null?void 0:U.value,currency:(S=l.totalTax)==null?void 0:S.currency},estimatedSubTotal:{excludingTax:{amount:(d=(G=l.subtotal)==null?void 0:G.excludingTax)==null?void 0:d.value,currency:(L=(A=l.subtotal)==null?void 0:A.excludingTax)==null?void 0:L.currency},includingTax:{amount:(I=(k=l.subtotal)==null?void 0:k.includingTax)==null?void 0:I.value,currency:(P=(N=l.subtotal)==null?void 0:N.includingTax)==null?void 0:P.currency},includingDiscountOnly:{amount:(C=(z=l.subtotal)==null?void 0:z.includingDiscountOnly)==null?void 0:C.value,currency:(x=(a=l.subtotal)==null?void 0:a.includingDiscountOnly)==null?void 0:x.currency}},estimatedGrandTotalPrice:{includingTax:{amount:(u=l.total)==null?void 0:u.includingTax.value,currency:(p=l.total)==null?void 0:p.includingTax.currency},excludingTax:{amount:(o=l.total)==null?void 0:o.excludingTax.value,currency:(i=l.total)==null?void 0:i.excludingTax.currency}},estimatedAppliedTaxes:{taxes:(n=l.appliedTaxes)==null?void 0:n.map(s=>{var f,w;return{label:s.label,amount:{value:(f=s.amount)==null?void 0:f.value,currency:(w=s.amount)==null?void 0:w.currency}}})},estimatedItems:{items:(Y=l.items)==null?void 0:Y.map(s=>{var f,w,j,Q,V,q,W,H,J,K;return{uid:s.uid,price:{amount:(f=s.price)==null?void 0:f.value,currency:(w=s.price)==null?void 0:w.currency},taxedPrice:{amount:(j=s.taxedPrice)==null?void 0:j.value,currency:(Q=s.taxedPrice)==null?void 0:Q.currency},rowTotal:{amount:(V=s.rowTotal)==null?void 0:V.value,currency:(q=s.rowTotal)==null?void 0:q.currency},rowTotalIncludingTax:{amount:(W=s.rowTotalIncludingTax)==null?void 0:W.value,currency:(H=s.rowTotalIncludingTax)==null?void 0:H.currency},regularPrice:{amount:(J=s.regularPrice)==null?void 0:J.value,currency:(K=s.regularPrice)==null?void 0:K.currency}}})}})}).finally(()=>{y(!1)})},estimatedTotals:b,loading:F}},Be=()=>{const[F,y]=m(!1),[b,_]=m([]),[v,h]=m("US"),[t,D]=m(""),[O,E]=m(""),[$,l]=m([]),[U,S]=m(!1),[G,d]=m(),[A,L]=m(),[k,I]=m(""),[N,P]=m(!1),z=()=>{h("US"),D(""),E(""),d(null),L(null),I(""),P(!1)},C=async x=>{const{shippingCountry:u,shippingState:p="",shippingZip:o=""}=x,i={countryCode:u,postcode:o,region:{region:p}};return y(!0),Xe(i).then(n=>(n&&(d({amount:n.amount.value,currency:n.amount.currency,priceIncludingtax:{amount:n.price_incl_tax.value,currency:n.price_incl_tax.currency},priceExcludingtax:{amount:n.price_excl_tax.value,currency:n.price_excl_tax.currency}}),L({carrier_code:n.carrier_code,method_code:n.method_code}),h(u),D(p),E(o),I(p||o||u),P(!0)),h(u),D(p),E(o),I(p||o||u),n)).finally(()=>{y(!1)})},a=x=>{x.preventDefault(),D(""),E("");const u=x.target.value;h(u)};return Z(()=>{Ge().then(x=>{let u="US";const p=x.map(o=>(o.isDefaultCountry&&(u=o.id),{text:o.label,value:o.id}));_(p),h(u)})},[]),Z(()=>{S(!0),ke(v).then(x=>{const u=x.map(p=>({text:p.name,value:p.code}));l(u)}).finally(()=>{S(!1)})},[v,S]),{loading:F,regionsLoading:U,estimatedDestinationText:k,countries:b,selectedCountry:v,selectedRegion:t,selectedZip:O,regions:$,estimatedShippingPrice:G,estimatedShippingMethod:A,shippingEstimated:N,handleEstimateShipping:C,handleCountrySelected:a,resetValues:z,setPriceSummaryLoading:y}},Re=({children:F,initialData:y=null,routeProduct:b,routeEmptyCartCTA:_,routeCheckout:v,...h})=>{var s,f,w,j,Q,V,q,W,H,J,K,ce,le,ue,oe;const[t,D]=m(y),[O,E]=m(new Set),{loading:$,countries:l,regions:U,selectedCountry:S,estimatedDestinationText:G,estimatedShippingPrice:d,handleCountrySelected:A,handleEstimateShipping:L,regionsLoading:k,selectedRegion:I,selectedZip:N,shippingEstimated:P,resetValues:z}=Be(),{handleEstimateTotals:C,estimatedTotals:a,loading:x}=ze(),u=(e,g)=>{E(T=>(e?T.add(g):T.delete(g),new Set(T)))},p=(e,g)=>{u(!0,e),we([{uid:e,quantity:g}]).finally(()=>{u(!1,e),G&&o({shippingCountry:S,shippingState:I,shippingZip:N})})},o=Te(e=>{L(e).then(g=>{if(g){const{carrier_code:T,method_code:X}=g;C(e,{carrier_code:T,method_code:X})}else C(e)}).then(()=>{Se(e)})},[L,C]),i=Fe({applyButton:"Cart.PriceSummary.estimatedShippingForm.apply.label",checkout:"Cart.PriceSummary.checkout",countryField:"Cart.PriceSummary.estimatedShippingForm.country.placeholder",discountedPrice:"Cart.CartItem.discountedPrice",download:"Cart.CartItem.download",freeShipping:"Cart.PriceSummary.freeShipping",heading:"Cart.Cart.heading",message:"Cart.CartItem.message",orderSummary:"Cart.PriceSummary.orderSummary",regularPrice:"Cart.CartItem.regularPrice",recipient:"Cart.CartItem.recipient",sender:"Cart.CartItem.sender",stateField:"Cart.PriceSummary.estimatedShippingForm.state.placeholder",taxToBeDetermined:"Cart.PriceSummary.taxToBeDetermined",zipField:"Cart.PriceSummary.estimatedShippingForm.zip.placeholder",file:"Cart.CartItem.file",files:"Cart.CartItem.files"});Z(()=>{const e=ae.on("cart/data",g=>{var X,B;D(g);const T=(B=(X=g==null?void 0:g.addresses)==null?void 0:X.shipping)==null?void 0:B[0];if(T){const{countryCode:M,regionCode:ee,zipCode:te}=T;o({shippingCountry:M,shippingState:ee,shippingZip:te})}},{eager:!0});return()=>{e==null||e.off()}},[]),Z(()=>{const e=ae.on("cart/merged",()=>{P&&o({shippingCountry:S,shippingState:I,shippingZip:N})});return()=>{e==null||e.off()}},[P,S,I,N]),Z(()=>{const e=ae.on("cart/reset",()=>{z(),Se(null)});return()=>{e==null||e.off()}},[]),Z(()=>{y&&Object.keys(y).length>0&&fe(y,be.locale||"en-US")},[y]);const n=(s=be.config)==null?void 0:s.shoppingCartDisplaySetting,Y=(t==null?void 0:t.totalQuantity)??0?r(De,{"data-testid":"price-summary",loading:$||x,heading:i.orderSummary,total:{price:a!=null&&a.estimatedGrandTotalPrice?r(c,{...a==null?void 0:a.estimatedGrandTotalPrice.includingTax}):r(c,{amount:t==null?void 0:t.total.includingTax.value,currency:t==null?void 0:t.total.includingTax.currency}),estimated:!0,priceWithoutTax:n!=null&&n.grandTotal?a!=null&&a.estimatedAppliedTaxes?r(c,{...a==null?void 0:a.estimatedGrandTotalPrice.excludingTax}):r(c,{amount:t==null?void 0:t.total.excludingTax.value,currency:t==null?void 0:t.total.excludingTax.currency}):void 0},subTotal:{taxIncluded:(n==null?void 0:n.subtotal)==="INCLUDING_TAX"&&!(n!=null&&n.zeroTax),taxExcluded:(n==null?void 0:n.subtotal)==="INCLUDING_EXCLUDING_TAX",zeroTaxSubtotal:n==null?void 0:n.zeroTax,priceExcludingTax:(f=a==null?void 0:a.estimatedSubTotal)!=null&&f.excludingTax?r(c,{"data-testid":"subtotal",...(w=a==null?void 0:a.estimatedSubTotal)==null?void 0:w.excludingTax}):r(c,{"data-testid":"subtotal",amount:(j=t==null?void 0:t.subtotal.excludingTax)==null?void 0:j.value,currency:(Q=t==null?void 0:t.subtotal.excludingTax)==null?void 0:Q.currency}),price:!(n!=null&&n.zeroTax)&&(n==null?void 0:n.subtotal)==="INCLUDING_TAX"||!(n!=null&&n.zeroTax)&&(n==null?void 0:n.subtotal)==="INCLUDING_EXCLUDING_TAX"?(V=a==null?void 0:a.estimatedSubTotal)!=null&&V.includingTax?r(c,{"data-testid":"subtotal",...(q=a==null?void 0:a.estimatedSubTotal)==null?void 0:q.includingTax}):r(c,{"data-testid":"subtotal",amount:(W=t==null?void 0:t.subtotal.includingTax)==null?void 0:W.value,currency:(H=t==null?void 0:t.subtotal.includingTax)==null?void 0:H.currency}):r(c,{"data-testid":"subtotal",amount:(J=t==null?void 0:t.subtotal.excludingTax)==null?void 0:J.value,currency:(K=t==null?void 0:t.subtotal.excludingTax)==null?void 0:K.currency})},shipping:t!=null&&t.isVirtual?void 0:{taxIncluded:(n==null?void 0:n.shipping)==="INCLUDING_TAX",taxExcluded:(n==null?void 0:n.shipping)==="INCLUDING_EXCLUDING_TAX",price:(d==null?void 0:d.amount)==0?r("span",{"data-testId":"free-shipping",children:i.freeShipping}):(n==null?void 0:n.shipping)==="INCLUDING_TAX"&&d?r(c,{"data-testid":"shipping",...d.priceIncludingtax}):d?r(c,{...d}):r("span",{children:i.taxToBeDetermined}),estimated:!0,priceExcludingTax:d!=null&&d.priceExcludingtax?r(c,{"data-testid":"shipping-excluding-tax",...d.priceExcludingtax}):r("span",{children:i.taxToBeDetermined}),countryField:r(ye,{name:"shippingCountry",placeholder:i.countryField,value:S,variant:"primary",options:l,handleSelect:A,"data-testid":"estimate-shipping-country-selector"}),stateField:U.length>0?r(ye,{name:"shippingState",placeholder:i.stateField,variant:"primary",options:U,value:I,"data-testid":"estimate-shipping-state-selector",disabled:k}):r(xe,{"aria-label":i.stateField,name:"shippingState",placeholder:i.stateField,variant:"primary",value:I,disabled:k,"data-testid":"estimate-shipping-state-input",maxLength:50}),zipField:r(xe,{"aria-label":i.zipField,name:"shippingZip",placeholder:i.zipField,variant:"primary","data-testid":"estimate-shipping-zip-input",value:N,maxLength:12}),estimateButton:r(ve,{variant:"secondary","data-testid":"estimate-shipping-apply-button","aria-label":i.applyButton,children:i.applyButton}),destinationText:G||i.taxToBeDetermined,onEstimate:o},taxTotal:t!=null&&t.isVirtual?{price:r("span",{"data-testid":"tax-total",children:i.taxToBeDetermined})}:{price:a!=null&&a.estimatedTaxTotal?r(c,{"data-testid":"tax-total",...a==null?void 0:a.estimatedTaxTotal}):t!=null&&t.totalTax?r(c,{"data-testid":"tax-total",amount:(ce=t==null?void 0:t.totalTax)==null?void 0:ce.value,currency:(le=t==null?void 0:t.totalTax)==null?void 0:le.currency}):r("span",{"data-testid":"tax-total",children:i.taxToBeDetermined}),estimated:!0},taxesApplied:t!=null&&t.isVirtual?void 0:n!=null&&n.fullSummary&&(a!=null&&a.estimatedAppliedTaxes)?(oe=(ue=a==null?void 0:a.estimatedAppliedTaxes)==null?void 0:ue.taxes)==null?void 0:oe.map(e=>({label:e.label,price:r(c,{"data-testid":"applied-taxes",amount:e.amount.value,currency:e.amount.currency})})):n!=null&&n.fullSummary?t==null?void 0:t.appliedTaxes.map(e=>({label:e.label,price:r(c,{"data-testid":"applied-taxes",amount:e.amount.value,currency:e.amount.currency})})):void 0,primaryAction:v?r(ve,{"data-testid":"checkout-button",variant:"primary",href:v({cartId:t.id}),children:i.checkout}):void 0,discounts:t==null?void 0:t.appliedDiscounts.map(e=>({label:e.label,price:r(c,{"data-testid":"summary-discount-total",amount:-e.amount.value,currency:e.amount.currency,sale:!0})}))}):void 0;return r(Ae,{...h,heading:r("div",{children:i.heading}),emptyCart:r(Pe,{ctaLinkURL:_==null?void 0:_()}),priceSummary:Y,products:(t==null?void 0:t.totalQuantity)??0?r(Ee,{children:t==null?void 0:t.items.map((e,g)=>{var B,M,ee,te,se,de,pe,ge,me,he;const T=O.has(e.uid),X={...e.bundleOptions??{},...e.selectedOptions??{},...e.customizableOptions,...e.recipient?{[i.recipient]:e.recipient}:{},...e.recipientEmail&&e.recipient?{[i.recipient]:`${e.recipient} (${e.recipientEmail})`}:{},...e.sender?{[i.sender]:e.sender}:{},...e.senderEmail&&e.sender?{[i.sender]:`${e.sender} (${e.senderEmail})`}:{},...e.message?{[i.message]:e.message}:{},...e.links&&e.links.count?e.links.count>1?{[i.files.replace("{count}",e.links.count.toString())]:e.links.result}:{[i.file.replace("{count}",e.links.count.toString())]:e.links.result}:{}};return r(Le,{ariaLabel:e.name,updating:T,"data-testid":"cart-item",taxIncluded:(n==null?void 0:n.price)==="INCLUDING_TAX",taxExcluded:(n==null?void 0:n.price)==="INCLUDING_EXCLUDING_TAX",image:b?r("a",{href:b(e),children:r(Ie,{loading:g<4?"eager":"lazy",src:e.image.src,alt:e.image.alt,width:"300",height:"300",params:{width:300}})}):r(Ie,{loading:g<4?"eager":"lazy",src:e.image.src,alt:e.image.alt,width:"300",height:"300",params:{width:300}}),title:r("span",{children:b?r("a",{href:b(e),children:e.name}):r(ne,{children:e.name})}),sku:r("span",{children:e.sku}),configurations:Object.keys(X).length>0?X:void 0,quantity:e.quantity,price:(n==null?void 0:n.price)==="INCLUDING_TAX"?r(c,{amount:e.discounted?(B=e.regularPrice)==null?void 0:B.value:(M=e.taxedPrice)==null?void 0:M.value,currency:e.discounted?(ee=e.regularPrice)==null?void 0:ee.currency:(te=e.taxedPrice)==null?void 0:te.currency,style:{font:"inherit"},"data-testid":"including-tax-item-price"}):r(c,{amount:(se=e.regularPrice)==null?void 0:se.value,currency:(de=e.regularPrice)==null?void 0:de.currency,style:{font:"inherit"},"data-testid":"regular-item-price"}),total:(n==null?void 0:n.price)==="INCLUDING_EXCLUDING_TAX"||(n==null?void 0:n.price)==="INCLUDING_TAX"?r(ne,{children:e.discounted?re(ne,{children:[r(c,{amount:e.total.value,currency:e.total.currency,variant:e.discounted?"strikethrough":"default","data-testid":"including-tax-row-total","aria-label":i.regularPrice}),r(c,{amount:(pe=e.rowTotalIncludingTax)==null?void 0:pe.value,currency:(ge=e.rowTotalIncludingTax)==null?void 0:ge.currency,sale:e.discounted,"data-testid":"discount-total","aria-label":i.discountedPrice})]}):r(c,{amount:e.rowTotalIncludingTax.value,currency:e.rowTotalIncludingTax.currency,"data-testid":"including-tax-row-total","aria-label":i.regularPrice})}):re(ne,{children:[r(c,{amount:e.total.value,currency:e.total.currency,variant:e.discounted?"strikethrough":"default","data-testid":"regular-total","aria-label":i.regularPrice}),e.discounted&&r(c,{amount:(me=e.discountedTotal)==null?void 0:me.value,currency:(he=e.discountedTotal)==null?void 0:he.currency,sale:e.discounted,"data-testid":"discount-total","aria-label":i.discountedPrice})]}),totalExcludingTax:(n==null?void 0:n.price)==="INCLUDING_EXCLUDING_TAX"?r(c,{amount:e.rowTotal.value,currency:e.rowTotal.currency,"data-testid":"excluding-tax-total","aria-label":i.regularPrice}):void 0,onQuantity:_e=>{p(e.uid,_e)},onRemove:()=>{p(e.uid,0)}},e.uid)})}):void 0})};Re.getInitialData=async function(){return Ce()};export{Re as Cart,Re as default};
