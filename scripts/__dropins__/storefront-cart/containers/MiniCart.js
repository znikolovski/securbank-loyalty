import{useState as T,useEffect as S}from"@dropins/tools/preact-compat.js";import{s as M,k as q}from"../chunks/resetCart.js";import{events as F}from"@dropins/tools/event-bus.js";import{E as R}from"../chunks/MiniCart.js";import{classes as A,VComponent as p}from"@dropins/tools/lib.js";import{Divider as V,Price as i,Button as O,CartList as B,CartItem as H,Image as $}from"@dropins/tools/components.js";import{jsxs as l,jsx as e,Fragment as _}from"@dropins/tools/preact-jsx-runtime.js";import{useText as j}from"@dropins/tools/i18n.js";import{b as J,u as K}from"../chunks/updateProductsFromCart.js";import"@dropins/tools/fetch-graphql.js";const W=({className:N,children:s,emptyCart:u,heading:g,products:o,subtotal:d,subtotalExcludingTaxes:y,ctas:t,...m})=>{const I=j({subtotal:"Cart.MiniCart.subtotal",subtotalExcludingTaxes:"Cart.MiniCart.subtotalExcludingTaxes"});return l("div",{...m,className:A(["cart-mini-cart",N]),children:[o&&g&&l("div",{className:"cart-mini-cart__heading",children:[e(p,{node:g,className:"cart-mini-cart__heading-text"}),e(V,{variant:"primary",className:"cart-mini-cart__heading-divider"})]}),o?l(_,{children:[e("div",{className:"cart-mini-cart__products",children:o}),l("div",{className:"cart-mini-cart__footer",children:[d&&l("div",{className:"cart-mini-cart__footer__estimated-total",children:[I.subtotal,e(p,{node:d})]}),y&&l("div",{className:"cart-mini-cart__footer__estimated-total-excluding-taxes",children:[I.subtotalExcludingTaxes,e(p,{node:y,className:A(["dropin-price-summary__price","dropin-price-summary__price--muted"])})]}),t&&e(p,{node:t,className:"cart-mini-cart__footer__ctas"})]})]}):e(p,{node:u,className:"cart-mini-cart__empty-cart"})]})},Y=({children:N,initialData:s=null,routeProduct:u,routeCart:g,routeCheckout:o,routeEmptyCartCTA:d,...y})=>{var v,x;const[t,m]=T(s),[I,z]=T(new Set),a=(v=M.config)==null?void 0:v.shoppingCartDisplaySetting,b=(r,c)=>{z(h=>(r?h.add(c):h.delete(c),new Set(h)))};S(()=>{const r=F.on("cart/data",c=>{m(c)},{eager:!0});return()=>{r==null||r.off()}},[]);const n=j({cartLink:"Cart.MiniCart.cartLink",checkoutLink:"Cart.MiniCart.checkoutLink",discountedPrice:"Cart.CartItem.discountedPrice",heading:"Cart.MiniCart.heading",message:"Cart.CartItem.message",recipient:"Cart.CartItem.recipient",regularPrice:"Cart.CartItem.regularPrice",sender:"Cart.CartItem.sender",file:"Cart.CartItem.file",files:"Cart.CartItem.files"}),Q=(r,c)=>{b(!0,r),K([{uid:r,quantity:c}]).finally(()=>{b(!1,r)})};return S(()=>{s&&Object.keys(s).length>0&&J(s,M.locale||"en-US")},[s]),e(W,{...y,heading:e("div",{children:n.heading.replace("{count}",((t==null?void 0:t.totalQuantity)??0).toString())}),emptyCart:e(R,{ctaLinkURL:d==null?void 0:d()}),subtotal:(t==null?void 0:t.subtotal)&&((a==null?void 0:a.subtotal)==="INCLUDING_TAX"||(a==null?void 0:a.subtotal)==="INCLUDING_EXCLUDING_TAX"?e(i,{amount:t==null?void 0:t.subtotal.includingTax.value,currency:t==null?void 0:t.subtotal.includingTax.currency,"data-testid":"subtotal-including-tax",style:{font:"inherit"}}):e(i,{amount:t==null?void 0:t.subtotal.excludingTax.value,currency:t==null?void 0:t.subtotal.excludingTax.currency,"data-testid":"subtotal-excluding-tax",style:{font:"inherit"}})),subtotalExcludingTaxes:(t==null?void 0:t.subtotal)&&((a==null?void 0:a.subtotal)==="INCLUDING_EXCLUDING_TAX"?e(i,{amount:t==null?void 0:t.subtotal.excludingTax.value,currency:t==null?void 0:t.subtotal.excludingTax.currency,"data-testid":"subtotal-including-excluding-tax",style:{font:"inherit"}}):void 0),ctas:l("div",{children:[o&&e(O,{variant:"primary",href:o(),children:n.checkoutLink}),g&&e(O,{variant:"tertiary",href:g(),children:n.cartLink})]}),products:(t==null?void 0:t.totalQuantity)??0?e(B,{children:(x=t==null?void 0:t.miniCartMaxItems)==null?void 0:x.map((r,c)=>{var f,k,C,U,P,w,D,E,G,X;const h=I.has(r.uid),L={...r.bundleOptions??{},...r.selectedOptions??{},...r.customizableOptions,...r.recipient?{[n.recipient]:r.recipient}:{},...r.recipientEmail&&r.recipient?{[n.recipient]:`${r.recipient} (${r.recipientEmail})`}:{},...r.sender?{[n.sender]:r.sender}:{},...r.senderEmail&&r.sender?{[n.sender]:`${r.sender} (${r.senderEmail})`}:{},...r.message?{[n.message]:r.message}:{},...r.links&&r.links.count?r.links.count>1?{[n.files.replace("{count}",r.links.count.toString())]:r.links.result}:{[n.file.replace("{count}",r.links.count.toString())]:r.links.result}:{}};return e(H,{"data-testid":"cart-item",updating:h,taxIncluded:(a==null?void 0:a.price)==="INCLUDING_TAX",taxExcluded:(a==null?void 0:a.price)==="INCLUDING_EXCLUDING_TAX",image:u?e("a",{href:u(r),children:e($,{loading:c<4?"eager":"lazy",src:r.image.src,alt:r.image.alt,width:"300",height:"300",params:{width:300}})}):e($,{loading:c<4?"eager":"lazy",src:r.image.src,alt:r.image.alt,width:"300",height:"300",params:{width:300}}),title:e("span",{children:u?e("a",{href:u(r),children:r.name}):r.name}),sku:e("span",{children:r.sku}),configurations:Object.keys(L).length>0?L:void 0,quantity:r.quantity,price:(a==null?void 0:a.price)==="INCLUDING_TAX"?e(i,{amount:r.discounted?(f=r.regularPrice)==null?void 0:f.value:(k=r.taxedPrice)==null?void 0:k.value,currency:r.discounted?(C=r.regularPrice)==null?void 0:C.currency:(U=r.taxedPrice)==null?void 0:U.currency,style:{font:"inherit"},"data-testid":"including-tax-item-price"}):e(i,{amount:(P=r.regularPrice)==null?void 0:P.value,currency:(w=r.regularPrice)==null?void 0:w.currency,style:{font:"inherit"},"data-testid":"regular-item-price"}),total:(a==null?void 0:a.price)==="INCLUDING_EXCLUDING_TAX"||(a==null?void 0:a.price)==="INCLUDING_TAX"?e(_,{children:r.discounted?l(_,{children:[e(i,{amount:r.total.value,currency:r.total.currency,variant:"strikethrough","data-testid":"including-tax-row-total","aria-label":n.regularPrice}),e(i,{amount:(D=r.rowTotalIncludingTax)==null?void 0:D.value,currency:(E=r.rowTotalIncludingTax)==null?void 0:E.currency,sale:r.discounted,"data-testid":"discount-total","aria-label":n.discountedPrice})]}):e(i,{amount:r.rowTotalIncludingTax.value,currency:r.rowTotalIncludingTax.currency,"data-testid":"including-tax-row-total","aria-label":n.regularPrice})}):l(_,{children:[e(i,{amount:r.total.value,currency:r.total.currency,variant:r.discounted?"strikethrough":"default","data-testid":"regular-total","aria-label":n.regularPrice}),r.discounted&&e(i,{amount:(G=r.discountedTotal)==null?void 0:G.value,currency:(X=r.discountedTotal)==null?void 0:X.currency,sale:r.discounted,"data-testid":"discount-total","aria-label":n.discountedPrice})]}),totalExcludingTax:(a==null?void 0:a.price)==="INCLUDING_EXCLUDING_TAX"?e(i,{amount:r.rowTotal.value,currency:r.rowTotal.currency,"data-testid":"excluding-tax-total","aria-label":n.regularPrice}):void 0,onRemove:()=>{Q(r.uid,0)}},r.uid)})}):void 0})};Y.getInitialData=async function(){return q()};export{Y as MiniCart,Y as default};
