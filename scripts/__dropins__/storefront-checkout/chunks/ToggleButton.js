import{events as fe}from"@dropins/tools/event-bus.js";import{B as z,i as re,V as L,u as ge,D as he,m as pe,l as Fe,E as ve}from"./getStoreConfig.js";import{b as K,a as v,A as N,e as Ie,D as q,g as Ee,M as Q,c as ee}from"./getMultilineValues.js";import{r as y}from"./transform-shipping-methods.js";import{useState as U,useEffect as x,useCallback as B,useRef as Ae,useMemo as ke}from"@dropins/tools/preact-hooks.js";import{classes as V,getFormErrors as Ce,VComponent as $}from"@dropins/tools/lib.js";import{Text as ne,useText as be}from"@dropins/tools/i18n.js";import{Field as Z,Input as oe,Picker as Se,Skeleton as Me,SkeletonRow as M,ProgressSpinner as we}from"@dropins/tools/components.js";/* empty css                     */import{jsx as a,Fragment as O,jsxs as P}from"@dropins/tools/preact-jsx-runtime.js";import{forwardRef as Re,useRef as $e,useImperativeHandle as Le,useState as j,useEffect as X}from"@dropins/tools/preact-compat.js";import{E as ye}from"./ErrorBanner.js";import{M as De}from"./MergedCartBanner.js";const Y={firstname:"given-name",lastname:"family-name",company:"organization",country:"country",region:"address-level1",city:"address-level2",postcode:"postal-code",telephone:"tel",street:"address-line1",email:"email",middlename:"additional-name",prefix:"honorific-prefix",suffix:"honorific-suffix"};function ae(e){return Object.keys(e).length===0&&e.constructor===Object}const Ne=e=>e.map(t=>{var o;const r=((o=t==null?void 0:t.id)==null?void 0:o.toString())||t.code;return{text:t.name,value:r}}),_e=e=>e?e.map(t=>({text:t.label,value:t.value})):[];function xe({address:e,addressType:t,availableCountries:r,availableRegions:o,config:s,dismissError:u,errors:n,fields:l,onBlur:f,onChange:p,onInvalid:i,onSelection:h,setAddress:E}){const F=()=>{E(c=>({...c,[v.Region]:"",[v.RegionId]:""})),u(v.Region)},b=c=>{E(S=>({...S,[v.RegionId]:c}))};return l.map(c=>{var g;let S,m=c.frontendInput,A,D=c.isDisabled,w=c.isRequired,R=[],k;if(m===z.Multiline?(k=K(c.code,e),S=K(c.code,n)):(k=e[c.code],S=n[c.code]||""),c.code===v.Country&&(R=_e(r),t===N.SHIPPING?(y.value.country=k,A=d=>{const I=d.target,{value:C}=I;C&&W({country_code:C}),h(d),F()}):A=h),c.code===v.RegionId&&t===N.SHIPPING&&(y.value.selectedRegionId=k),c.code===v.Region){if(t===y.value.addressType&&(D=y.value.pending),w=s.countriesWithRequiredRegion.includes(e==null?void 0:e.country_id),R=Ne(o),!w&&!s.displayStateIfOptional&&(m=z.Undefined),m=R.length>0?z.Select:z.Text,m===z.Select)t===N.SHIPPING?(y.value.selectedRegion=k,A=d=>{const C=d.target.value;W({country_code:y.value.country,region_id:C}),h(d),b(C)}):A=d=>{h(d);const C=d.target.value;b(C)};else if(m===z.Text&&t===N.SHIPPING){y.value.selectedRegion=k;const d=p;p=I=>{const C=I.target,{value:H}=C;y.value.country&&W({country_code:y.value.country,region_name:H}),d(I)}}k=R.length>0?((g=R.find(d=>d.value===k))==null?void 0:g.value)||"":k}return c.code===v.PostCode&&(w=!s.countriesWithOptionalZipCode.includes(e==null?void 0:e.country_id)),{...c,error:S,frontendInput:m,handleSelect:A,isDisabled:D,isRequired:w,onBlur:f,onChange:p,onInvalid:i,options:R,value:k}})}let te;function W(e){var u;const t=re.value.data,r=!!t,o=(u=t==null?void 0:t.shippingAddresses)==null?void 0:u[0],s=o==null?void 0:o.availableShippingMethods;r&&!s&&(clearTimeout(te),te=setTimeout(()=>{Ie({cartId:t.id,criteria:e})},q))}const G=({addressType:e,code:t,index:r})=>r?`${e}-${t}-${r}`:`${e}-${t}`,T=e=>`checkout-address-form__${e}`,ze=({addressType:e,element:t})=>{const{code:r,value:o,defaultValue:s}=t;return a("input",{className:T(r),id:G({addressType:e,code:r}),name:r,type:"hidden",value:o||s},r)},Be=({addressType:e,element:t})=>{const{code:r,error:o,isDisabled:s,label:u,onBlur:n,onChange:l,onInvalid:f,validateRules:p,value:i}=t,h=se(p);return a(Z,{disabled:s,error:o,children:a(oe,{"aria-label":u,autocomplete:Y[r]||"off",className:T(r),floatingLabel:`${u} ${t.isRequired?"*":""}`,id:G({addressType:e,code:r}),onBlur:n,onChange:l,onInvalid:f,placeholder:u,required:t.isRequired||!1,type:"text",name:r,value:i??void 0,...h})})},Pe=({addressType:e,element:t})=>{const{code:r,error:o,isDisabled:s,isRequired:u,label:n,multilineCount:l,onBlur:f,onChange:p,onInvalid:i,validateRules:h,value:E}=t,F=l??0,b=se(h);return a(O,{children:Array.from(Array(F).keys()).map(c=>a(Z,{disabled:s,error:(o==null?void 0:o[c])||"",className:"dropin-field--multiline",children:a(oe,{id:G({addressType:e,code:r,index:c}),className:T(r),floatingLabel:`${n} ${c!=0?c:""} ${u&&c===0?"*":""}`,autocomplete:c===0?Y[r]:"off","aria-label":n,placeholder:`${n} ${c!=0?c:""}`,type:"text",required:u&&c===0,onChange:p,onBlur:f,onInvalid:i,name:`${r}-${c}`,value:(E==null?void 0:E[c])||void 0,...b})},`${r}-${c}`))})},Oe=({addressType:e,element:t})=>{const{code:r,error:o,handleSelect:s,isDisabled:u,isRequired:n,label:l,onBlur:f,onInvalid:p,options:i,value:h}=t,E=s?{handleSelect:s}:{};return a(Z,{disabled:u,error:o,children:a(Se,{id:G({addressType:e,code:r}),className:T(r),name:r,floatingLabel:`${l} ${n?"*":""}`,required:n,placeholder:l,"aria-label":l,options:i,value:h,autocomplete:Y[r]||"off",onBlur:f,onInvalid:p,...E},r)})},Ve=({addressType:e,element:t})=>{switch(t.frontendInput){case"BOOLEAN":case"DATE":case"DATETIME":case"FILE":case"GALLERY":case"IMAGE":case"MEDIA_IMAGE":case"MULTISELECT":case"PRICE":case"TEXTAREA":case"UNDEFINED":case"WEIGHT":return null;case"HIDDEN":return ze({addressType:e,element:t});case"TEXT":return Be({addressType:e,element:t});case"MULTILINE":return Pe({addressType:e,element:t});case"SELECT":return Oe({addressType:e,element:t});default:return null}},se=e=>e?e.reduce((t,r)=>{switch(r.name){case L.DateRangeMax:return{...t,max:r.value};case L.DateRangeMin:return{...t,min:r.value};case L.FileExtensions:return{...t,accept:r.value};case L.InputValidation:return{...t,pattern:Ue(r.value)};case L.MaxFileSize:case L.MaxImageHeight:case L.MaxImageWidth:return t;case L.MaxTextLength:return{...t,maxLength:r.value};case L.MinTextLength:return{...t,minLength:r.value};default:throw new Error(`Unknown rule: ${r.name}`)}},{}):{},_={alpha:/^[a-zA-Z]+$/,alphanumeric:/^[a-zA-Z0-9]+$/,"alphanumeric-w-space":/^[a-zA-Z0-9 ]+$/,"alphanum-with-spaces":/^[a-zA-Z0-9 ]+$/,email:/^([a-z0-9,!#$%&'*+/=?^_`{|}~-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z0-9,!#$%&'*+/=?^_`{|}~-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*@([a-z0-9-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z0-9-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*\.(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]){2,})$/i,numeric:/^[0-9]+$/,url:/^((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=+$,\w]+@)?[A-Za-z0-9.-]+|(?:www\.|[-;:&=+$,\w]+@)[A-Za-z0-9.-]+)((?:\/[+~%/.\w\-_]*)?\??(?:[-+=&;%@.\w_]*)#?(?:[.!/\\\w]*))?)$/},Ue=e=>{switch(e){case"alpha":return _.alpha.source;case"alphanumeric":return _.alphanumeric.source;case"alphanumeric-w-space":return _["alphanumeric-w-space"].source;case"alphanum-with-spaces":return _["alphanum-with-spaces"].source;case"url":return _.url.source;case"numeric":return _.numeric.source;case"email":return _.email.source;default:throw new Error(`Unknown validation type: ${e}`)}},Ge=e=>P(Me,{...e,children:[a(M,{variant:"heading",size:"medium"}),a(M,{variant:"empty",size:"medium"}),a(M,{size:"large"}),a(M,{size:"large"}),a(M,{size:"large",fullWidth:!0}),a(M,{size:"large",fullWidth:!0,lines:3}),a(M,{size:"large"}),a(M,{size:"large"}),a(M,{size:"large"}),a(M,{size:"large"}),a(M,{size:"large"}),a(M,{size:"large"}),a(M,{size:"large"})]}),Te=({addressType:e,className:t,fields:r,formRef:o,headingId:s,name:u,...n})=>P("div",{...n,className:V(["checkout-fields-form",t]),children:[a(ue,{level:2,children:a(ne,{id:s}),className:"checkout-fields-form__title"}),a("form",{name:u,ref:o,className:V(["checkout-fields-form__form",t]),noValidate:!0,children:r.sort((l,f)=>!l.sortOrder||!f.sortOrder?l.code<f.code?-1:1:l.sortOrder-f.sortOrder).map(l=>Ve({element:l,addressType:e}))})]}),He=e=>{const t=new FormData(e),r=Object.fromEntries(t);return Object.entries(r).reduce((s,[u])=>{const n=e.elements[u];return n!=null&&n.validationMessage?{...s,[u]:n.validationMessage}:{...s}},{})};function We(e){const[t,r]=j({});return X(()=>{e&&r(o=>({...o,country_id:e}))},[e]),{defaultValues:t}}function qe({country:e,addressType:t}){const[r,o]=j([]);return X(()=>{if(!e){o([]);return}Ee(e,t).then(s=>{o(s||[])}).catch(s=>{console.error(s)})},[o,e,t]),{availableRegions:r}}function Ze({autoFill:e,addressType:t,dismissError:r,loadAutoFill:o}){const[s,u]=j(!1),n=Fe.value.data,l=!!n,f=re.value.data,p=!!f;X(()=>{var S;if(!e||!p||s)return;let i,h=!1;i=nt({addressType:t,cart:f}),!i&&l&&(i=rt({addressType:t,customer:n}),h=!0);const E=m=>m?m.split(ee).length>1:!1;if(!i)return;u(!0);const F={[v.City]:i.city,[v.Company]:i.company||"",[v.Country]:i.country.value,[v.FirstName]:i.firstName,[v.LastName]:i.lastName,[v.PostCode]:i.postCode||"",[v.Telephone]:i.telephone||"",[v.Vat]:i.vatId||""},b=i.region;if(b){const m=(S=b==null?void 0:b.id)==null?void 0:S.toString();m?(F[v.Region]=m,F[v.RegionId]=m):F[v.Region]=b.code}i!=null&&i.street&&i.street.length>0&&i.street.forEach((m,A)=>{F[`${v.Street}${Q}${A}`]=m}),((i==null?void 0:i.customAttributes)||[]).forEach(m=>{E(m.code)?m.value.split(ee).forEach((D,w)=>{F[`${m.code}${Q}${w}`]=D}):F[m.code]=m.value}),o({values:F,triggerAutoSave:h})},[t,e,f,n,s,p,l,o,r])}const bt=Re(({addressType:e,autoFill:t=!0,children:r,headingId:o,name:s,preselectedFields:u,saveAddressHandler:n,...l},f)=>{const{fields:p}=ge(),{countries:i}=he(),h=i===void 0,E=p===void 0,{config:F}=pe(),b=F===void 0,{defaultValues:c}=We(F==null?void 0:F.defaultCountry),S=tt({fields:p,preselectedFields:u}),m=$e(null),{address:A,errors:D,loadAutoFill:w,onBlur:R,dismissError:k,onChange:g,onInvalid:d,onSelection:I,setAddress:C}=Qe({formRef:m,type:e,defaultValues:c,preselection:S,saveAddressHandler:n}),{availableRegions:H}=qe({country:A.country_id,addressType:e});if(Le(f,()=>({triggerSaveAddress:de=>{if(!m.current)return;const me=He(m.current);if(ae(me))return n({signal:de,address:A})}})),Ze({addressType:e,autoFill:t,loadAutoFill:w,dismissError:k}),E||h||b)return a(Ge,{"data-testid":`${e}-skeleton`});const le=xe({address:A,addressType:e,availableCountries:i,availableRegions:H,config:F,dismissError:k,errors:D,fields:p,onBlur:R,onChange:g,onInvalid:d,onSelection:I,setAddress:C}),J={[N.SHIPPING]:"shipping",[N.BILLING]:"billing"};return a(Te,{...l,name:s,addressType:e,className:`checkout-${J[e]}-form`,"data-testid":`${J[e]}-form`,fields:le,formRef:m,headingId:o})});function je(e){const{backupService:t}=ve(),[r,o]=U(null);x(()=>{const n=t.restore(e);n&&o(n)},[e,t]),x(()=>{const n=fe.on("checkout/order",()=>{t.remove(e)});return()=>{n==null||n.off()}},[e,t]);const s=B(n=>setTimeout(()=>{t.backup(e,n)},q),[e,t]),u=B(()=>{t.remove(e)},[e,t]);return{addressBackup:r,backup:s,removeBackup:u}}const Xe={badInput:"aria-label",patternMismatch:"aria-label",rangeOverflow:"max",rangeUnderflow:"min",tooLong:"maxlength",tooShort:"minlength",typeMismatch:"aria-label",valueMissing:"aria-label"},Ye=["badInput","patternMismatch","rangeOverflow","rangeUnderflow","tooLong","tooShort","typeMismatch","valueMissing"],Je=e=>{const[t,r]=U({}),o=B(n=>{const{name:l,validity:f,validationMessage:p}=n;let i=f.valid?"":p;Ye.forEach(h=>{if(!f[h])return;const E=e[h];if(!E)return;const F=Xe[h];i=E.replace("{field}",n.getAttribute(F)||"")}),r(h=>({...h,[l]:i}))},[e]);return{errors:t,dismissError:n=>{t[n]&&r(l=>{const{[n]:f,...p}=l;return p})},validateFormElement:o,resetErrors:()=>{r({})}}},Ke=e=>{const t=e.current;if(!t)return!1;const r=Ce(t);return ae(r)},Qe=({formRef:e,type:t,defaultValues:r={},preselection:o={},saveAddressHandler:s})=>{const u=be({badInput:"Checkout.AddressForm.Validity.badInput",patternMismatch:"Checkout.AddressForm.Validity.patternMismatch",rangeUnderflow:"Checkout.AddressForm.Validity.rangeUnderflow",tooLong:"Checkout.AddressForm.Validity.tooLong",tooShort:"Checkout.AddressForm.Validity.tooShort",typeMismatch:"Checkout.AddressForm.Validity.typeMismatch",valueMissing:"Checkout.AddressForm.Validity.valueMissing"}),n=Ae(!1),[l,f]=U({}),{addressBackup:p,backup:i,removeBackup:h}=je(t),{errors:E,validateFormElement:F,dismissError:b,resetErrors:c}=Je(u),S=B(g=>{n.current=!1,s(g).then(()=>{h()}).catch(d=>{n.current=!0,console.error("Saving address form failed:",d)})},[h,s]),m=(g,d)=>{f(I=>({...I,[g]:d})),n.current=!0},A=({values:g,triggerAutoSave:d=!1})=>{c(),f(I=>({...I,...g})),d&&(n.current=!0)},D=g=>{const d=g.target,{name:I,value:C}=d;m(I,C),F(d)},w=g=>{const d=g.target;F(d)},R=g=>{const d=g.target,{name:I,value:C}=d;m(I,C),F(d)},k=g=>{g.target.checkValidity()};return x(()=>{f(g=>({...r,...o,...p,...g}))},[r,o,p]),x(()=>{if(!n.current)return;const g=i(l);return()=>{clearTimeout(g)}},[l,i]),x(()=>{if(!n.current||!Ke(e))return;const g=new AbortController,d=g.signal,I=setTimeout(()=>{S({signal:d,address:l})},q);return()=>{clearTimeout(I),g.abort()}},[l,e,S]),{address:l,errors:E,loadAutoFill:A,dismissError:b,onChange:D,onSelection:R,onBlur:k,onInvalid:w,setAddress:f}},et={countryCode:v.Country,region:v.Region,postCode:v.PostCode};function tt({fields:e,preselectedFields:t}){return ke(()=>!(!!e&&e.length>0)||!!!t?{}:Object.keys(t).reduce((s,u)=>{const n=et[u];return!n||!e.some(f=>f.code===n)?s:{...s,[n]:t[u]}},{}),[e,t])}const rt=({addressType:e,customer:t})=>e===N.BILLING?t.defaultBillingAddress:t.defaultShippingAddress,nt=({addressType:e,cart:t})=>{if(e===N.BILLING)return t.billingAddress;const r=t.shippingAddresses;if(!(!r||r.length===0))return r[0]},ot=()=>{const e=()=>window.innerWidth>=1920?"xxlarge":window.innerWidth>=1366?"xlarge":window.innerWidth>=1024?"large":window.innerWidth>=768?"medium":"small",[t,r]=U(e());return x(()=>{let o;const s=()=>{o&&clearTimeout(o),o=setTimeout(()=>r(e()),50)};return window.addEventListener("resize",s),()=>{window.removeEventListener("resize",s),o&&clearTimeout(o)}},[]),t},ie=({children:e,className:t})=>ot()==="small"?a(O,{children:e}):a("div",{className:t,children:e}),at=({sections:e})=>a(ie,{className:"checkout__aside",children:P(O,{children:[a($,{node:e.orderSummary}),a($,{node:e.cartSummary})]})}),st=({billingAddress:e,billToShippingAddress:t,login:r,paymentMethods:o,placeOrder:s,shippingAddress:u,shippingMethods:n})=>P(O,{children:[a($,{node:r}),u&&a($,{node:u}),t&&a($,{node:t}),n&&a($,{node:n}),a($,{node:o}),a($,{node:e}),a($,{node:s})]}),it=({outOfStock:e,sections:t})=>a(ie,{className:"checkout__main",children:P(O,{children:[a(ue,{level:1,className:"checkout-title",children:a(ne,{id:"Checkout.title"})}),e&&a($,{className:"checkout-outOfStock",node:e}),t&&a(st,{...t})]})}),ce=({children:e,className:t,isLoading:r=!1,...o})=>P("div",{"data-testid":"checkout",className:V(["checkout",t]),...o,children:[r&&a(ut,{}),a(ye,{}),a(De,{}),a("div",{className:"checkout__content",children:e})]});ce.Main=it;ce.Aside=at;const ue=({className:e,children:t,level:r=2})=>{const o=r>=1&&r<=6?`h${r}`:"h2";return a(o,{className:e,children:t})},ct=()=>{const e=B(()=>{document.body.style.overflow="hidden"},[]),t=B(()=>{document.body.style.overflow=""},[]);return{lockScroll:e,unlockScroll:t}},ut=({className:e})=>{const{lockScroll:t,unlockScroll:r}=ct();return x(()=>(t(),r),[t,r]),a("div",{"data-testid":"checkout-overlay-loader",className:V(["checkout-overlay-loader",e]),children:a(we,{})})};export{bt as A,ce as C,ue as H,_ as p,ot as u};
//# sourceMappingURL=ToggleButton.js.map
