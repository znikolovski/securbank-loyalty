{"version":3,"file":"BillingForm.js","sources":["../../src/containers/BillingForm/BillingForm.tsx"],"sourcesContent":["import { prepareAddress, setBillingAddress } from '@/checkout/api';\nimport {\n  AddressForm,\n  AddressFormHandle,\n  SaveAddressCommand,\n} from '@/checkout/components/AddressForm';\nimport { compareAddresses } from '@/checkout/containers/BillToShippingAddress';\nimport { BILLING_FORM_NAME } from '@/checkout/containers/BillingForm';\nimport { useAddressFormFields } from '@/checkout/context/address-form-fields';\nimport { AddressFormType } from '@/checkout/data/models';\nimport {\n  cartSignal,\n  customerSignal,\n  isBillToShippingSignal,\n} from '@/checkout/signals';\nimport { Container } from '@adobe/elsie/lib';\nimport {\n  HTMLAttributes,\n  useCallback,\n  useEffect,\n  useMemo,\n  useRef,\n} from 'preact/compat';\n\nexport interface BillingFormProps extends HTMLAttributes<HTMLDivElement> {}\n\nexport const BillingForm: Container<BillingFormProps> = (props) => {\n  const addressFormRef = useRef<AddressFormHandle>(null);\n\n  const { fields } = useAddressFormFields();\n\n  const customer = customerSignal.value.data;\n  const defaultBillingAddress = customer?.defaultBillingAddress;\n\n  const cart = cartSignal.value.data;\n  const cartId = cart?.id || '';\n  const billingAddress = cart?.billingAddress;\n  const shippingAddress = cart?.shippingAddresses?.[0];\n\n  const { checked, setByUser } = isBillToShippingSignal.value;\n  const isVisible = !checked;\n\n  const autoFillForm = useMemo(() => {\n    if (!fields || !isVisible) return false;\n    if (!billingAddress) return !!defaultBillingAddress;\n    return !compareAddresses(fields, billingAddress, shippingAddress);\n  }, [\n    isVisible,\n    fields,\n    billingAddress,\n    shippingAddress,\n    defaultBillingAddress,\n  ]);\n\n  const saveAddressHandler = useCallback(\n    (command: SaveAddressCommand) => {\n      return setBillingAddress({\n        signal: command.signal,\n        cartId,\n        input: {\n          address: checked ? undefined : prepareAddress(command.address),\n          same_as_shipping: checked,\n        },\n      });\n    },\n    [cartId, checked]\n  );\n\n  useEffect(() => {\n    if (!setByUser) return;\n\n    const controller = new AbortController();\n\n    if (!checked) {\n      addressFormRef.current!.triggerSaveAddress(controller.signal);\n    }\n\n    return () => {\n      controller.abort();\n    };\n  }, [checked, setByUser]);\n\n  return (\n    <AddressForm\n      {...props}\n      addressType={AddressFormType.BILLING}\n      autoFill={autoFillForm}\n      data-testid=\"billing-form\"\n      headingId=\"Checkout.BillingAddress.title\"\n      name={BILLING_FORM_NAME}\n      ref={addressFormRef}\n      saveAddressHandler={saveAddressHandler}\n      style={{ display: isVisible ? 'block' : 'none' }}\n    />\n  );\n};\n"],"names":["BillingForm","props","addressFormRef","useRef","fields","useAddressFormFields","customer","customerSignal","value","data","defaultBillingAddress","cart","cartSignal","cartId","id","billingAddress","shippingAddress","shippingAddresses","checked","setByUser","isBillToShippingSignal","isVisible","autoFillForm","useMemo","compareAddresses","saveAddressHandler","useCallback","command","setBillingAddress","signal","input","address","undefined","prepareAddress","same_as_shipping","useEffect","controller","AbortController","current","triggerSaveAddress","abort","_jsx","AddressForm","addressType","AddressFormType","BILLING","autoFill","headingId","name","BILLING_FORM_NAME","ref","style","display"],"mappings":"okBA0BO,MAAMA,EAAsDC,GAAA,OAC3DC,MAAAA,EAAiBC,EAA0B,IAAI,EAE/C,CAAEC,OAAAA,GAAWC,EAAqB,EAElCC,EAAWC,EAAeC,MAAMC,KAChCC,EAAwBJ,GAAAA,YAAAA,EAAUI,sBAElCC,EAAOC,EAAWJ,MAAMC,KACxBI,GAASF,GAAAA,YAAAA,EAAMG,KAAM,GACrBC,EAAiBJ,GAAAA,YAAAA,EAAMI,eACvBC,GAAkBL,EAAAA,GAAAA,YAAAA,EAAMM,oBAANN,YAAAA,EAA0B,GAE5C,CAAEO,QAAAA,EAASC,UAAAA,CAAAA,EAAcC,EAAuBZ,MAChDa,EAAY,CAACH,EAEbI,EAAeC,EAAQ,IACvB,CAACnB,GAAU,CAACiB,EAAkB,GAC7BN,EACE,CAACS,EAAiBpB,EAAQW,EAAgBC,CAAe,EADpC,CAAC,CAACN,EAE7B,CACDW,EACAjB,EACAW,EACAC,EACAN,CAAqB,CACtB,EAEKe,EAAqBC,EACxBC,GACQC,EAAkB,CACvBC,OAAQF,EAAQE,OAChBhB,OAAAA,EACAiB,MAAO,CACLC,QAASb,EAAUc,OAAYC,EAAeN,EAAQI,OAAO,EAC7DG,iBAAkBhB,CACpB,CAAA,CACD,EAEH,CAACL,EAAQK,CAAO,CAClB,EAEAiB,OAAAA,EAAU,IAAM,CACd,GAAI,CAAChB,EAAW,OAEViB,MAAAA,EAAa,IAAIC,gBAEvB,OAAKnB,GACYoB,EAAAA,QAASC,mBAAmBH,EAAWP,MAAM,EAGvD,IAAM,CACXO,EAAWI,MAAM,CAAA,CACnB,EACC,CAACtB,EAASC,CAAS,CAAC,EAGrBsB,EAACC,EAAW,CAAA,GACNzC,EACJ0C,YAAaC,EAAgBC,QAC7BC,SAAUxB,EACV,cAAY,eACZyB,UAAU,gCACVC,KAAMC,EACNC,IAAKhD,EACLuB,mBAAAA,EACA0B,MAAO,CAAEC,QAAS/B,EAAY,QAAU,MAAO,CAAA,CAChD,CAEL"}